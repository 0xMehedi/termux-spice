#!/data/data/com.termux/files/usr/bin/bash

########################################################################
# Termux URL Opener Handle
# Execute termux-url-opener
#
# Copyright (C) 2022 Mehedi Hasan
#
# Author(s): Mehedi Hasan <0xmehedi@tutanota.com>
#
# Webpage  : https://github.com/0xMehedi/termux-spice
#
# Any questions, comments, or bug reports may be sent to
# above email address. Enjoy "Termux Spice"!
#
# License  : MIT License
########################################################################

# yt-dlp Configuration Location
YD_CFG="${HOME}/.config/yt-dlp/config"

# yt-dlp Options
YDO_COMMON="\
--force-ipv4 \
--concurrent-fragments 2 \
--throttled-rate 56K \
--output ${HOME}/storage/downloads/%(title)s.%(ext)s \
--no-overwrites \
--no-mtime \
--sleep-interval 5 \
--max-sleep-interval 15 \
--check-formats \
--merge-output-format mkv \
--embed-metadata \
--embed-chapters"

YDO_AUDIO="--extract-audio"

YDO_VIDEO="\
--sub-langs all,-live_chat \
--embed-subs"

BEST_AUDIO="(bestaudio[acodec^=opus]/bestaudio)"

# Display Menu Options
printf '%s\n' "Â© 2022 Mehedi Hasan"
printf '%s\n\n' "https://github.com/0xMehedi"
printf '%s\n' "To Download Audio Only,  Input 1"
printf '%s\n' "To Download 720p Video,  Input 2"
printf '%s\n' "To Download 1080p Video, Input 3"
printf '%s\n' "To Download 1440p Video, Input 4"
printf '%s\n' "To Download 2160p Video, Input 5"
printf '%s\n' "For Best Quality Video,  Input 0"

# Read User Input
read -r INPUT

# Validate User Input & Update yt-dlp Configuration
if ! expr "${INPUT}" : "^[0-5]" > /dev/null; then
  printf '\n%s\n' "Bailing out, as it can only be attributed to human error."
  exit 1

elif [ "${INPUT}" -eq "1" ]; then
  printf '%s\n' "${YDO_COMMON} ${YDO_AUDIO} --format \"${BEST_AUDIO}\"" > "${YD_CFG}"

elif [ "${INPUT}" -eq "2" ]; then
  printf '%s\n' "${YDO_COMMON} ${YDO_VIDEO} --format \"bestvideo[height<=720]+${BEST_AUDIO}\"" > "${YD_CFG}"

elif [ "${INPUT}" -eq "3" ]; then
  printf '%s\n' "${YDO_COMMON} ${YDO_VIDEO} --format \"bestvideo[height<=1080]+${BEST_AUDIO}\"" > "${YD_CFG}"

elif [ "${INPUT}" -eq "4" ]; then
  printf '%s\n' "${YDO_COMMON} ${YDO_VIDEO} --format \"bestvideo[height<=1440]+${BEST_AUDIO}\"" > "${YD_CFG}"

elif [ "${INPUT}" -eq "5" ]; then
  printf '%s\n' "${YDO_COMMON} ${YDO_VIDEO} --format \"bestvideo[height<=2160]+${BEST_AUDIO}\"" > "${YD_CFG}"

elif [ "${INPUT}" -eq "0" ]; then
  printf '%s\n' "${YDO_COMMON} ${YDO_VIDEO} --format \"bestvideo+${BEST_AUDIO}\"" > "${YD_CFG}"
fi

# Download Files from the Shared URL
yt-dlp "$1"
